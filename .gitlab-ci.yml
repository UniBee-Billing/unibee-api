stages:
  - build
  - push
  - deploy
  - hub_push
#  - nm_stage_deploy

variables:
  IMAGE_GROUP: xxx
  NAME_SPACE: xxx
  GOPATH: ${CI_PROJECT_DIR}/.go
  GOMODCACHE: ${CI_PROJECT_DIR}/.go/pkg/mod
  GOCACHE: ${CI_PROJECT_DIR}/.go/.cache/go-build
  GOLANGCI_LINT_CACHE: ${CI_PROJECT_DIR}/.go/.cache/golangci-lint

build:
  only:
    - main
  stage: build
  image: golang
  script:
    - ls -al /data/
    - go env -w GOPROXY=https://goproxy.cn,direct
    - go get
    - GOOS=linux GOARCH=amd64 go build -o temp/linux_amd64/main main.go
    - chmod +x temp/linux_amd64/main
    - cp temp/linux_amd64/main /data/artifacts/unibee_api

push:
  only:
    - main
  image: docker
  stage: push
  script:
    - mkdir -p temp/linux_amd64
    - cp /data/artifacts/unibee_api temp/linux_amd64/main
    - rm -rf version.txt && echo "buildtime:"$(date +%Y%m%d%H%M)"" > version.txt
    - chmod +x temp/linux_amd64/main
    - docker build -f manifest/docker/Dockerfile -t easzlab.io.local:5000/unibee/unibee-api:daily --platform linux/amd64 .
    - docker push easzlab.io.local:5000/unibee/unibee-api:daily

deploy:
  only:
    - main
  image: registry.cn-shenzhen.aliyuncs.com/heiku/kubectl:latest
  stage: deploy
  script:
    - kubectl --kubeconfig /data/kubeconfigs/unib_dev_configs rollout restart deployment/yd-unib-server-daily


hub_push:
  only:
    - main
  image: docker
  stage: hub_push
  script:
    - echo ${CI_REGISTRY_USER}
    - echo ${CI_REGISTRY_PASSWORD}
    - docker login -u ${CI_REGISTRY_USER} -p ${CI_REGISTRY_PASSWORD}
    - docker tag easzlab.io.local:5000/unibee/unibee-api:daily unibee/api:stage
    - docker push unibee/api:stage

#nm_stage_deploy:
#  only:
#    - main
#  image: registry.cn-shenzhen.aliyuncs.com/heiku/kubectl:latest
#  stage: deploy
#  script:
#    - kubectl --kubeconfig /data/kubeconfigs/nodemaven_dev_config rollout restart deployment/unibee-api
